# Certbot Manager 优化规划

## 项目现状分析

当前项目是一个功能强大的纯Shell脚本工具，用于简化Let's Encrypt SSL证书的申请、管理和续期。但存在以下问题：

1. **单文件结构**：所有功能（1465行代码）都集中在一个脚本中，导致代码臃肿
2. **功能模块划分不清晰**：虽然有函数封装，但整体结构不够模块化
3. **交互逻辑复杂**：包含多层嵌套菜单，用户体验不够简洁
4. **代码冗余**：部分功能实现过于复杂，存在重复代码
5. **可扩展性差**：添加新功能需要修改主文件，不利于维护

## 优化目标

1. **模块化设计**：将不同功能拆分为独立模块，提高代码可读性和可维护性
2. **核心功能聚焦**：保留最常用的核心功能，简化不必要的复杂逻辑
3. **简洁交互界面**：提供更直观的命令行界面，减少嵌套菜单
4. **配置灵活性**：支持配置文件，方便用户自定义设置
5. **跨平台兼容性**：保持对主流Linux发行版和macOS的支持

## 核心功能模块设计

### 1. 基础架构模块
- **主程序入口**：处理命令行参数和调用相应模块
- **配置管理**：加载和解析配置文件
- **工具函数**：通用工具函数（颜色输出、用户输入、权限检查等）

### 2. 系统检查模块
- Certbot安装状态检查
- Nginx安装状态和配置检查
- 证书数量统计
- 自动续期状态检查

### 3. Certbot管理模块
- Certbot安装
- Certbot卸载
- Certbot版本检查

### 4. 证书管理模块
- 证书创建
- 证书列出
- 证书续期
- 证书卸载

### 5. 自动续期模块
- Systemd timer配置
- Cron任务配置
- 续期状态检查

## 新的文件结构

```
certbot-manager/
├── certbot-manager.sh      # 主程序入口
├── config.example.conf     # 示例配置文件
├── README.md               # 项目文档
└── modules/
    ├── base.sh             # 基础架构模块
    ├── system.sh           # 系统检查模块
    ├── certbot.sh          # Certbot管理模块
    ├── certificate.sh      # 证书管理模块
    └── renewal.sh          # 自动续期模块
```

## 核心功能实现

### 1. 简化命令行界面

```bash
# 基本命令
sudo ./certbot-manager.sh status      # 显示系统状态
sudo ./certbot-manager.sh install     # 安装certbot
sudo ./certbot-manager.sh create example.com  # 创建证书
sudo ./certbot-manager.sh list        # 列出证书
sudo ./certbot-manager.sh renew       # 续期证书
sudo ./certbot-manager.sh renew-setup # 设置自动续期
sudo ./certbot-manager.sh help        # 显示帮助
```

### 2. 模块化代码组织

- 每个功能模块独立成文件，通过主程序统一调用
- 模块间通过函数调用和返回值进行通信
- 统一的错误处理机制

### 3. 配置文件支持

```ini
# 配置示例
[certbot]
email = admin@example.com
domains = example.com,www.example.com

[nginx]
config_path = /etc/nginx/conf.d/

[renewal]
method = systemd  # systemd 或 cron
time = 00:00
```

### 4. 简化交互逻辑

- 减少嵌套菜单，提供直接的命令行选项
- 保持必要的交互式提示，但简化流程
- 提供清晰的错误信息和解决方案

### 5. 代码质量提升

- 使用更现代的Shell脚本语法（Bash 4.0+）
- 完善的错误处理和边界情况检查
- 清晰的函数命名和注释
- 统一的代码风格

## 实施步骤

1. **拆分核心功能**：将现有脚本拆分为基础架构、系统检查、Certbot管理、证书管理和自动续期模块
2. **实现主程序入口**：创建新的主程序，处理命令行参数和调用相应模块
3. **添加配置文件支持**：实现配置文件加载和解析功能
4. **简化命令行界面**：重构命令行参数处理，提供更直观的命令选项
5. **优化交互逻辑**：简化交互式菜单，减少嵌套层级
6. **测试和验证**：在不同平台上测试核心功能，确保兼容性
7. **更新文档**：编写新的README和使用说明

## 预期效果

1. **代码结构更清晰**：模块化设计使代码更易于维护和扩展
2. **功能更聚焦**：只保留最常用的核心功能，简化用户体验
3. **使用更便捷**：提供直接的命令行选项，减少交互步骤
4. **可扩展性更强**：新功能可以作为独立模块添加，无需修改主程序
5. **跨平台兼容性更好**：优化的代码结构更易于适配不同平台

通过以上优化，Certbot Manager将成为一个更轻量、更易用、更易于维护的SSL证书管理工具，同时保留所有核心功能。